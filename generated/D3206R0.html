<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="mpark/wg21" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2025-01-13" />
  <title>A sender query for completion behaviour</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
      div.csl-block{margin-left: 1.5em;}
      ul.task-list{list-style: none;}
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {  background-color: #f6f8fa; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span { } /* Normal */
      code span.al { color: #ff0000; } /* Alert */
      code span.an { } /* Annotation */
      code span.at { } /* Attribute */
      code span.bn { color: #9f6807; } /* BaseN */
      code span.bu { color: #9f6807; } /* BuiltIn */
      code span.cf { color: #00607c; } /* ControlFlow */
      code span.ch { color: #9f6807; } /* Char */
      code span.cn { } /* Constant */
      code span.co { color: #008000; font-style: italic; } /* Comment */
      code span.cv { color: #008000; font-style: italic; } /* CommentVar */
      code span.do { color: #008000; } /* Documentation */
      code span.dt { color: #00607c; } /* DataType */
      code span.dv { color: #9f6807; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #9f6807; } /* Float */
      code span.fu { } /* Function */
      code span.im { } /* Import */
      code span.in { color: #008000; } /* Information */
      code span.kw { color: #00607c; } /* Keyword */
      code span.op { color: #af1915; } /* Operator */
      code span.ot { } /* Other */
      code span.pp { color: #6f4e37; } /* Preprocessor */
      code span.re { } /* RegionMarker */
      code span.sc { color: #9f6807; } /* SpecialChar */
      code span.ss { color: #9f6807; } /* SpecialString */
      code span.st { color: #9f6807; } /* String */
      code span.va { } /* Variable */
      code span.vs { color: #9f6807; } /* VerbatimString */
      code span.wa { color: #008000; font-weight: bold; } /* Warning */
      code.diff {color: #898887}
      code.diff span.va {color: #006e28}
      code.diff span.st {color: #bf0303}
  </style>
  <style type="text/css">
body {
margin: 5em;
font-family: serif;

hyphens: auto;
line-height: 1.35;
text-align: justify;
}
@media screen and (max-width: 30em) {
body {
margin: 1.5em;
}
}
div.wrapper {
max-width: 60em;
margin: auto;
}
ul {
list-style-type: none;
padding-left: 2em;
margin-top: -0.2em;
margin-bottom: -0.2em;
}
a {
text-decoration: none;
color: #4183C4;
}
a.hidden_link {
text-decoration: none;
color: inherit;
}
li {
margin-top: 0.6em;
margin-bottom: 0.6em;
}
h1, h2, h3, h4 {
position: relative;
line-height: 1;
}
a.self-link {
position: absolute;
top: 0;
left: calc(-1 * (3.5rem - 26px));
width: calc(3.5rem - 26px);
height: 2em;
text-align: center;
border: none;
transition: opacity .2s;
opacity: .5;
font-family: sans-serif;
font-weight: normal;
font-size: 83%;
}
a.self-link:hover { opacity: 1; }
a.self-link::before { content: "ยง"; }
ul > li:before {
content: "\2014";
position: absolute;
margin-left: -1.5em;
}
:target { background-color: #C9FBC9; }
:target .codeblock { background-color: #C9FBC9; }
:target ul { background-color: #C9FBC9; }
.abbr_ref { float: right; }
.folded_abbr_ref { float: right; }
:target .folded_abbr_ref { display: none; }
:target .unfolded_abbr_ref { float: right; display: inherit; }
.unfolded_abbr_ref { display: none; }
.secnum { display: inline-block; min-width: 35pt; }
.header-section-number { display: inline-block; min-width: 35pt; }
.annexnum { display: block; }
div.sourceLinkParent {
float: right;
}
a.sourceLink {
position: absolute;
opacity: 0;
margin-left: 10pt;
}
a.sourceLink:hover {
opacity: 1;
}
a.itemDeclLink {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
opacity: 0;
}
a.itemDeclLink:hover { opacity: 1; }
span.marginalizedparent {
position: relative;
left: -5em;
}
li span.marginalizedparent { left: -7em; }
li ul > li span.marginalizedparent { left: -9em; }
li ul > li ul > li span.marginalizedparent { left: -11em; }
li ul > li ul > li ul > li span.marginalizedparent { left: -13em; }
div.footnoteNumberParent {
position: relative;
left: -4.7em;
}
a.marginalized {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
}
a.enumerated_item_num {
position: relative;
left: -3.5em;
display: inline-block;
margin-right: -3em;
text-align: right;
width: 3em;
}
div.para { margin-bottom: 0.6em; margin-top: 0.6em; text-align: justify; }
div.section { text-align: justify; }
div.sentence { display: inline; }
span.indexparent {
display: inline;
position: relative;
float: right;
right: -1em;
}
a.index {
position: absolute;
display: none;
}
a.index:before { content: "โต"; }

a.index:target {
display: inline;
}
.indexitems {
margin-left: 2em;
text-indent: -2em;
}
div.itemdescr {
margin-left: 3em;
}
.bnf {
font-family: serif;
margin-left: 40pt;
margin-top: 0.5em;
margin-bottom: 0.5em;
}
.ncbnf {
font-family: serif;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
}
.ncsimplebnf {
font-family: serif;
font-style: italic;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
background: inherit; 
}
span.textnormal {
font-style: normal;
font-family: serif;
white-space: normal;
display: inline-block;
}
span.rlap {
display: inline-block;
width: 0px;
}
span.descr { font-style: normal; font-family: serif; }
span.grammarterm { font-style: italic; }
span.term { font-style: italic; }
span.terminal { font-family: monospace; font-style: normal; }
span.nonterminal { font-style: italic; }
span.tcode { font-family: monospace; font-style: normal; }
span.textbf { font-weight: bold; }
span.textsc { font-variant: small-caps; }
a.nontermdef { font-style: italic; font-family: serif; }
span.emph { font-style: italic; }
span.techterm { font-style: italic; }
span.mathit { font-style: italic; }
span.mathsf { font-family: sans-serif; }
span.mathrm { font-family: serif; font-style: normal; }
span.textrm { font-family: serif; }
span.textsl { font-style: italic; }
span.mathtt { font-family: monospace; font-style: normal; }
span.mbox { font-family: serif; font-style: normal; }
span.ungap { display: inline-block; width: 2pt; }
span.textit { font-style: italic; }
span.texttt { font-family: monospace; }
span.tcode_in_codeblock { font-family: monospace; font-style: normal; }
span.phantom { color: white; }

span.math { font-style: normal; }
span.mathblock {
display: block;
margin-left: auto;
margin-right: auto;
margin-top: 1.2em;
margin-bottom: 1.2em;
text-align: center;
}
span.mathalpha {
font-style: italic;
}
span.synopsis {
font-weight: bold;
margin-top: 0.5em;
display: block;
}
span.definition {
font-weight: bold;
display: block;
}
.codeblock {
margin-left: 1.2em;
line-height: 127%;
}
.outputblock {
margin-left: 1.2em;
line-height: 127%;
}
div.itemdecl {
margin-top: 2ex;
}
code.itemdeclcode {
white-space: pre;
display: block;
}
span.textsuperscript {
vertical-align: super;
font-size: smaller;
line-height: 0;
}
.footnotenum { vertical-align: super; font-size: smaller; line-height: 0; }
.footnote {
font-size: small;
margin-left: 2em;
margin-right: 2em;
margin-top: 0.6em;
margin-bottom: 0.6em;
}
div.minipage {
display: inline-block;
margin-right: 3em;
}
div.numberedTable {
text-align: center;
margin: 2em;
}
div.figure {
text-align: center;
margin: 2em;
}
table {
border: 1px solid black;
border-collapse: collapse;
margin-left: auto;
margin-right: auto;
margin-top: 0.8em;
text-align: left;
hyphens: none; 
}
td, th {
padding-left: 1em;
padding-right: 1em;
vertical-align: top;
}
td.empty {
padding: 0px;
padding-left: 1px;
}
td.left {
text-align: left;
}
td.right {
text-align: right;
}
td.center {
text-align: center;
}
td.justify {
text-align: justify;
}
td.border {
border-left: 1px solid black;
}
tr.rowsep, td.cline {
border-top: 1px solid black;
}
tr.even, tr.odd {
border-bottom: 1px solid black;
}
tr.capsep {
border-top: 3px solid black;
border-top-style: double;
}
tr.header {
border-bottom: 3px solid black;
border-bottom-style: double;
}
th {
border-bottom: 1px solid black;
}
span.centry {
font-weight: bold;
}
div.table {
display: block;
margin-left: auto;
margin-right: auto;
text-align: center;
width: 90%;
}
span.indented {
display: block;
margin-left: 2em;
margin-bottom: 1em;
margin-top: 1em;
}
ol.enumeratea { list-style-type: none; background: inherit; }
ol.enumerate { list-style-type: none; background: inherit; }

code.sourceCode > span { display: inline; }
</style>
  <link href="data:image/x-icon;base64,AAABAAIAEBAAAAEAIABoBAAAJgAAACAgAAABACAAqBAAAI4EAAAoAAAAEAAAACAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAVoJEAN6CRADegkQAWIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wCCRAAAgkQAAIJEAACCRAAsgkQAvoJEAP+CRAD/gkQA/4JEAP+CRADAgkQALoJEAACCRAAAgkQAAP///wD///8AgkQAAIJEABSCRACSgkQA/IJEAP99PQD/dzMA/3czAP99PQD/gkQA/4JEAPyCRACUgkQAFIJEAAD///8A////AHw+AFiBQwDqgkQA/4BBAP9/PxP/uZd6/9rJtf/bybX/upd7/39AFP+AQQD/gkQA/4FDAOqAQgBc////AP///wDKklv4jlEa/3o7AP+PWC//8+3o///////////////////////z7un/kFox/35AAP+GRwD/mVYA+v///wD///8A0Zpk+NmibP+0d0T/8evj///////+/fv/1sKz/9bCs//9/fr//////+/m2/+NRwL/nloA/5xYAPj///8A////ANKaZPjRmGH/5cKh////////////k149/3UwAP91MQD/lmQ//86rhv+USg3/m1YA/5hSAP+bVgD4////AP///wDSmmT4zpJY/+/bx///////8+TV/8mLT/+TVx//gkIA/5lVAP+VTAD/x6B//7aEVv/JpH7/s39J+P///wD///8A0ppk+M6SWP/u2sf///////Pj1f/Nj1T/2KFs/8mOUv+eWhD/lEsA/8aee/+0glT/x6F7/7J8Rvj///8A////ANKaZPjRmGH/48Cf///////+/v7/2qt//82PVP/OkFX/37KJ/86siv+USg7/mVQA/5hRAP+bVgD4////AP///wDSmmT40ppk/9CVXP/69O////////7+/v/x4M//8d/P//7+/f//////9u7n/6tnJf+XUgD/nFgA+P///wD///8A0ppk+NKaZP/RmWL/1qNy//r07///////////////////////+vXw/9akdP/Wnmn/y5FY/6JfFvj///8A////ANKaZFTSmmTo0ppk/9GYYv/Ql1//5cWm//Hg0P/x4ND/5cWm/9GXYP/RmGH/0ppk/9KaZOjVnmpY////AP///wDSmmQA0ppkEtKaZI7SmmT60ppk/9CWX//OkVb/zpFW/9CWX//SmmT/0ppk/NKaZJDSmmQS0ppkAP///wD///8A0ppkANKaZADSmmQA0ppkKtKaZLrSmmT/0ppk/9KaZP/SmmT/0ppkvNKaZCrSmmQA0ppkANKaZAD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkUtKaZNzSmmTc0ppkVNKaZADSmmQA0ppkANKaZADSmmQA////AP5/AAD4HwAA4AcAAMADAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAMADAADgBwAA+B8AAP5/AAAoAAAAIAAAAEAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAyCRACMgkQA6oJEAOqCRACQgkQAEIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRABigkQA5oJEAP+CRAD/gkQA/4JEAP+CRADqgkQAZoJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAA4gkQAwoJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQAxIJEADyCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAP///wD///8A////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAWgkQAmIJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAJyCRAAYgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAdIJEAPCCRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAPSCRAB4gkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQASoJEANKCRAD/gkQA/4JEAP+CRAD/g0YA/39AAP9zLgD/bSQA/2shAP9rIQD/bSQA/3MuAP9/PwD/g0YA/4JEAP+CRAD/gkQA/4JEAP+CRADUgkQAToJEAACCRAAAgkQAAP///wD///8A////AP///wB+PwAAgkUAIoJEAKiCRAD/gkQA/4JEAP+CRAD/hEcA/4BBAP9sIwD/dTAA/5RfKv+viF7/vp56/76ee/+wiF7/lWAr/3YxAP9sIwD/f0AA/4RHAP+CRAD/gkQA/4JEAP+CRAD/gkQArIJEACaBQwAA////AP///wD///8A////AIBCAEBzNAD6f0EA/4NFAP+CRAD/gkQA/4VIAP92MwD/bSUA/6N1Tv/ezsL/////////////////////////////////38/D/6V3Uv9uJgD/dTEA/4VJAP+CRAD/gkQA/4JEAP+BQwD/fUAA/4FDAEj///8A////AP///wD///8AzJRd5qBlKf91NgD/dDUA/4JEAP+FSQD/cy4A/3YyAP/PuKP//////////////////////////////////////////////////////9K7qP94NQD/ciwA/4VJAP+CRAD/fkEA/35BAP+LSwD/mlYA6v///wD///8A////AP///wDdpnL/4qx3/8KJUv+PUhf/cTMA/3AsAP90LgD/4dK+/////////////////////////////////////////////////////////////////+TYxf91MAD/dTIA/31CAP+GRwD/llQA/6FcAP+gWwD8////AP///wD///8A////ANGZY/LSm2X/4ap3/92mcP+wdT3/byQA/8mwj////////////////////////////////////////////////////////////////////////////+LYxv9zLgP/jUoA/59bAP+hXAD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/RmWL/1p9q/9ubXv/XqXj////////////////////////////7+fD/vZyG/6BxS/+gcUr/vJuE//r37f//////////////////////3MOr/5dQBf+dVQD/nVkA/5xYAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmWP/yohJ//jo2P//////////////////////4NTG/4JDFf9lGAD/bSQA/20kAP9kGAD/fz8S/+Xb0f//////5NG9/6txN/+LOgD/m1QA/51aAP+cWAD/m1cA/5xYAP+cWADy////AP///wD///8A////ANKaZPLSmmT/0ppk/8+TWf/Unmv//v37//////////////////////+TWRr/VwsA/35AAP+ERgD/g0UA/4JGAP9lHgD/kFga/8KXX/+TRwD/jT4A/49CAP+VTQD/n10A/5xYAP+OQQD/lk4A/55cAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/y4tO/92yiP//////////////////////8NnE/8eCQP+rcTT/ez0A/3IyAP98PgD/gEMA/5FSAP+USwD/jj8A/5lUAP+JNwD/yqV2/694Mf+HNQD/jkAA/82rf/+laBj/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/LiUr/4byY///////////////////////gupX/0I5P/+Wuev/Lklz/l1sj/308AP+QSwD/ol0A/59aAP+aVQD/k0oA/8yoh///////+fXv/6pwO//Lp3v///////Pr4f+oay7y////AP///wD///8A////ANKaZPLSmmT/0ppk/8uJSv/hvJj//////////////////////+G7l//Jhkb/0ppk/96nc//fqXX/x4xO/6dkFP+QSQD/llEA/5xXAP+USgD/yaOA///////38uv/qG05/8ijdv//////8efb/6ZpLPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/zIxO/9yxh///////////////////////7dbA/8iEQf/Sm2X/0Zlj/9ScZv/eqHf/2KJv/7yAQf+XTgD/iToA/5lSAP+JNgD/yKFv/611LP+HNQD/jT8A/8qmeP+kZRT/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/Pk1n/1J5q//78+//////////////////+/fv/1aFv/8iEQv/Tm2b/0ppl/9GZY//Wn2z/1pZc/9eldf/Bl2b/kUcA/4w9AP+OQAD/lUwA/59eAP+cWQD/jT8A/5ZOAP+eXADy////AP///wD///8A////ANKaZPLSmmT/0ppk/9KZY//KiEn/8d/P///////////////////////47+f/05tm/8iCP//KiEj/yohJ/8eCP//RmGH//vfy///////n1sP/rXQ7/4k4AP+TTAD/nVoA/5xYAP+cVwD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/0ptl/8uLTf/aq37////////////////////////////+/fz/6c2y/961jv/etY7/6Myx//78+v//////////////////////3MWv/5xXD/+ORAD/mFQA/51ZAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmmT/0ppk/8mFRP/s1b//////////////////////////////////////////////////////////////////////////////+PD/0JFU/7NzMv+WUQD/kUsA/5tXAP+dWQDy////AP///wD///8A////ANKaZP/SmmT/0ppk/9KaZP/Sm2X/z5NZ/8yMT//z5NX/////////////////////////////////////////////////////////////////9Ofa/8yNUP/UmGH/36p5/8yTWv+qaSD/kksA/5ROAPz///8A////AP///wD///8A0ppk5NKaZP/SmmT/0ppk/9KaZP/TnGf/zY9T/82OUv/t1sD//////////////////////////////////////////////////////+7Yw//OkFX/zI5R/9OcZ//SmmP/26V0/9ymdf/BhUf/ol8R6P///wD///8A////AP///wDSmmQ80ppk9tKaZP/SmmT/0ppk/9KaZP/TnGj/zpFW/8qJSv/dson/8uHS//////////////////////////////////Lj0//etIv/y4lL/86QVf/TnGj/0ppk/9KaZP/RmWP/05xn/9ymdfjUnWdC////AP///wD///8A////ANKaZADSmmQc0ppkotKaZP/SmmT/0ppk/9KaZP/Tm2b/0Zli/8qJSf/NjlH/16Z3/+G8mP/myKr/5siq/+G8mP/Xp3f/zY5S/8qISf/RmGH/05tm/9KaZP/SmmT/0ppk/9KaZP/SmmSm0pljINWdaQD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkQtKaZMrSmmT/0ppk/9KaZP/SmmT/0ptl/9GYYf/Nj1P/y4lL/8qISP/KiEj/y4lK/82PU//RmGH/0ptl/9KaZP/SmmT/0ppk/9KaZP/SmmTO0ppkRtKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZGzSmmTu0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmTw0ppkcNKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZBLSmmSQ0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppklNKaZBTSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQy0ppkutKaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppkvtKaZDbSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkXNKaZODSmmT/0ppk/9KaZP/SmmT/0ppk5NKaZGDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkBtKaZIbSmmTo0ppk6tKaZIrSmmQK0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP/8P///+B///+AH//+AAf//AAD//AAAP/AAAA/gAAAHwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA+AAAAfwAAAP/AAAP/8AAP//gAH//+AH///4H////D//" rel="icon" />
  
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="wrapper">
<header id="title-block-header">
<h1 class="title" style="text-align:center">A sender query for
completion behaviour</h1>
<table style="border:none;float:right">
  <tr>
    <td>Document #:</td>
    <td>
      P3206R0
      [<a href="https://wg21.link/P3206">Latest</a>]
      [<a href="https://wg21.link/P3206/status">Status</a>]
    </td>
  </tr>
  <tr>
    <td>Date:</td>
    <td>2025-01-13</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Project:</td>
    <td>Programming Language C++</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Audience:</td>
    <td>
      SG1<br>
    </td>
  </tr>
  <tr>
    <td style="vertical-align:top">Reply-to:</td>
    <td>
      Maikel Nadolski<br>&lt;<a href="mailto:maikel.nadolski@gmail.com" class="email">maikel.nadolski@gmail.com</a>&gt;<br>
    </td>
  </tr>
</table>
</header>
<div style="clear:both">
<h1 data-number="1" id="abstract"><span class="header-section-number">1</span> Abstract<a href="#abstract" class="self-link"></a></h1>
<p>A sender query is proposed to improve the lifetime management for
child operation states. There is no wording in this paper yet.</p>
<h1 data-number="2" id="introduction"><span class="header-section-number">2</span> Introduction<a href="#introduction" class="self-link"></a></h1>
<p>This proposal partially continues on <span class="citation" data-cites="P2257R0"><a href="https://wg21.link/p2257r0" role="doc-biblioref">[P2257R0]</a></span>. It proposes the query <code class="sourceCode cpp">execution<span class="op">::</span>get_completion_behaviour</code>
that determines whether an async operation completes inline, synchronous
or asynchronously with a call to <code class="sourceCode cpp">execution<span class="op">::</span>start</code>.
This corresponds to the completion guarantees in <span class="citation" data-cites="P2257R0"><a href="https://wg21.link/p2257r0" role="doc-biblioref">[P2257R0]</a></span>. The current proposal does not
include a query to investigate whether starting an operation will block
an execution agent.</p>
<p>Knowing whether an operation completes synchronously changes the way
how the lifetime of the operation state can be managed, and inline
completion implies synchronous completion. No guarantees regarding the
completion behaviour are being made, if no suitable overload for a
sender and environment pair is being found.</p>
<p>Awaitables have a very similar way to convey this information by
returning
<code class="sourceCode cpp"><span class="kw">true</span></code> or
<code class="sourceCode cpp"><span class="kw">false</span></code> for
<code class="sourceCode cpp">await_ready<span class="op">()</span></code>.
Without this proposal senders in <code class="sourceCode cpp">std<span class="op">::</span>execution</code> are
missing a tool to do so.</p>
<p>This query proves to be instrumental in optimizing the behavior for
some algorithms, including but not limited to
<code class="sourceCode cpp">sync_wait<span class="op">()</span></code>,
<code class="sourceCode cpp">repeat<span class="op">()</span></code>-like
algorithms, the <code class="sourceCode cpp">as_awaitable<span class="op">()</span></code>
helper or a scheduler-affine coroutine task type.</p>
<h2 data-number="2.1" id="sync_wait-algorithm"><span class="header-section-number">2.1</span>
<code class="sourceCode cpp">sync_wait</code> algorithm<a href="#sync_wait-algorithm" class="self-link"></a></h2>
<p>A possible implementation of
<code class="sourceCode cpp">sync_wait</code> synchronizes the
completion of the input operation with some signaling mechanism. If the
input operation is known to complete synchronously,
<code class="sourceCode cpp">sync_wait</code> does not need the
synchronization primitives in its implementation.</p>
<h2 data-number="2.2" id="repeat-like-algorithms"><span class="header-section-number">2.2</span>
<code class="sourceCode cpp">repeat</code>-like algorithms<a href="#repeat-like-algorithms" class="self-link"></a></h2>
<p>Consider a typical <code class="sourceCode cpp">repeat</code>-like
sender algorithm that repeats the construction and initiation of an
input operation.</p>
<p>A usual implementation reconstructs and starts a child operation from
within the value completion of an intermediate receiver. If the
completion behaviour of the child operation is not known, one needs to
mitigate a possible recursive call stack e.g., by rescheduling on a
lightweight scheduler.</p>
<p>If the child operation completes synchronously a
<code class="sourceCode cpp">repeat</code>-like algorithm can be
implemented with a while loop, similar to the following snippet:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> stopped<span class="op">{</span><span class="kw">false</span><span class="op">}</span>;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>optional<span class="op">&lt;</span>connect_result_t<span class="op">&lt;</span>Sender, repeat_receiver<span class="op">&gt;&gt;</span> child_op<span class="op">(</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>in_place,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    emplace_from<span class="op">{[&amp;]</span> <span class="op">{</span> <span class="cf">return</span> exection<span class="op">::</span><span class="fu">connect</span><span class="op">(</span>sender, repeat_receiver<span class="op">{&amp;</span>stopped<span class="op">})</span>; <span class="op">}})</span>;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(!</span>stopped<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  execution<span class="op">::</span>start<span class="op">(*</span>child_op<span class="op">)</span>;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  child_op<span class="op">.</span>emplace<span class="op">(</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      emplace_from<span class="op">{[&amp;]</span> <span class="op">{</span> <span class="cf">return</span> exection<span class="op">::</span><span class="fu">connect</span><span class="op">(</span>sender, repeat_receiver<span class="op">{&amp;</span>stopped<span class="op">})</span>; <span class="op">}})</span>;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 data-number="2.3" id="as_awaitable"><span class="header-section-number">2.3</span>
<code class="sourceCode cpp">as_awaitable</code><a href="#as_awaitable" class="self-link"></a></h2>
<p>The current specification of
<code class="sourceCode cpp">as_awaitable</code> transforms senders into
awaitable that can not use symmetric transfer, even if it would be
feasible, because the necessary information is not available.
Consequently, starting the following code will run into stack-exhaustion
on a typical machine</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> promise;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> coroutine <span class="op">:</span> std<span class="op">::</span>coroutine_handle<span class="op">&lt;</span>promise<span class="op">&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> promise_type <span class="op">=</span> <span class="op">::</span>promise;</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> promise <span class="op">:</span> std<span class="op">::</span>execution<span class="op">::</span>with_awaitable_senders<span class="op">&lt;</span>promise<span class="op">&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    coroutine get_return_object<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">{</span>coroutine<span class="op">::</span>from_promise<span class="op">(*</span><span class="kw">this</span><span class="op">)}</span>; <span class="op">}</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>suspend_never initial_suspend<span class="op">()</span> <span class="kw">noexcept</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">{}</span>; <span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>suspend_never final_suspend<span class="op">()</span> <span class="kw">noexcept</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">{}</span>; <span class="op">}</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> return_void<span class="op">()</span> <span class="op">{}</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> unhandled_exception<span class="op">()</span> <span class="op">{}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>coroutine f<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// this will most likely produce stack-overflow</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span>; i <span class="op">&lt;</span> <span class="dv">1&#39;000&#39;000</span>; <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">co_await</span> std<span class="op">::</span>execution<span class="op">::</span>just<span class="op">()</span>;</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    f<span class="op">()</span>; </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note, that senders are allowed to provide custom implementations for
<code class="sourceCode cpp">as_awaitable</code> by providing the
respective class member method. To the author it is not clear how this
customization point scales with the composition of sender algorithms and
synchronous senders. This proposal allows to statically detect
synchronous or inline completion behaviour of the operation and
transforms a sender into an awaitable that symmetrically transfers the
control back to its parent coroutine in a scheduler-affine fashion.
Transforming a synchronous sender can, for example, look like this</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span>synchronous<span class="op">-</span>single<span class="op">-</span>sender<span class="op">&lt;</span>env_type<span class="op">&gt;</span> S<span class="op">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> awaiter <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  S sender;</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  variant<span class="op">&lt;</span>monostate, single<span class="op">-</span>value<span class="op">-</span>result<span class="op">-</span>of<span class="op">&lt;</span>S<span class="op">&gt;</span>, exception_ptr<span class="op">&gt;</span> result;</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> await_ready<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="kw">false</span>; <span class="op">}</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> P<span class="op">&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  coroutine_handle<span class="op">&lt;</span>P<span class="op">&gt;</span> await_suspend<span class="op">(</span>coroutine_handle<span class="op">&lt;</span>P<span class="op">&gt;</span> h<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> op <span class="op">=</span> <span class="fu">connect</span><span class="op">(</span>std<span class="op">::</span>move<span class="op">(</span>sender<span class="op">)</span>, receiver_t<span class="op">{&amp;</span>result, get_env<span class="op">(</span>h<span class="op">.</span>promise<span class="op">())})</span>;</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    op<span class="op">.</span>start<span class="op">()</span>;</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> h;</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  single<span class="op">-</span>value<span class="op">-</span>result<span class="op">-</span>of<span class="op">&lt;</span>S<span class="op">&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  await_resume<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check the state of result and</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// either return the value or</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// rethrow the exception </span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h2 data-number="2.4" id="scheduler-affine-task-type"><span class="header-section-number">2.4</span> scheduler-affine task type<a href="#scheduler-affine-task-type" class="self-link"></a></h2>
<p>Consider a scheduler-affine coroutine task type that ensures that
each awaited expression completes on the currently assigned
scheduler.</p>
<p>Ideally, one wants to avoid to reschedule an await-expression if it
did not change the current execution resource. This opens up the
question on how to identify such senders and awaitables that complete on
the scheduler that started them.</p>
<p>One family of senders are those whose value completion scheduler is
known and is equal to the starting scheduler.</p>
<p>Another family of senders are those whose corresponding
sender-awaitable will resume on the current thread of execution. This
proposal helps to identify the second group of senders.</p>
<h1 data-number="3" id="proposal"><span class="header-section-number">3</span> Proposal<a href="#proposal" class="self-link"></a></h1>
<p>Let <code class="sourceCode cpp">s</code> denote a sender and
<code class="sourceCode cpp">env</code> an environment type. I propose a
customization point object <code class="sourceCode cpp">execution<span class="op">::</span>get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
with an interface that is similar to
<code class="sourceCode cpp">get_completion_signatures</code>. Authors
of sender algorithms can define</p>
<ol type="1">
<li>a possibly env-dependent member method on the sender type</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> InputSender<span class="op">&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> example_sender_adaptor <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// [...]</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> Self, <span class="kw">class</span><span class="op">...</span> Env<span class="op">&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">requires</span> <span class="op">(</span><span class="kw">sizeof</span><span class="op">...(</span>Env<span class="op">)</span> <span class="op">&lt;=</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="kw">auto</span> get_completion_behaviour<span class="op">(</span><span class="kw">this</span> Self<span class="op">&amp;&amp;</span> self, Env<span class="op">&amp;&amp;...</span> env<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> execution<span class="op">::</span>get_completion_behaviour<span class="op">(</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        std<span class="op">::</span>forward_like<span class="op">&lt;</span>Self<span class="op">&gt;(</span>self<span class="op">.</span>sender<span class="op">)</span>, std<span class="op">::</span>forward<span class="op">&lt;</span>Env<span class="op">&gt;(</span>env<span class="op">)...)</span>;</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  InputSender sender;</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<ol start="2" type="1">
<li>a type alias if the completion behaviour is statically known and
does not depend on the environment</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> example_sender1 <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// [...]</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> completion_behaviour <span class="op">=</span> constant<span class="op">&lt;</span>execution<span class="op">::</span>completion_behaviour<span class="op">::</span>asynchronous<span class="op">&gt;</span>;</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<h2 data-number="3.1" id="executionget_completion_behaviour"><span class="header-section-number">3.1</span> <code class="sourceCode cpp">execution<span class="op">::</span>get_completion_behaviour</code><a href="#executionget_completion_behaviour" class="self-link"></a></h2>
<p>The return type of <code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
is convertible to <code class="sourceCode cpp">execution<span class="op">::</span>completion_behaviour</code>.</p>
<ul>
<li><p><code class="sourceCode cpp">completion_behaviour<span class="op">::</span>inline_completion</code>:
The connected receiverโs completion-signal will occur on the calling
thread before <code class="sourceCode cpp">execution<span class="op">::</span>start<span class="op">()</span></code>
returns.</p></li>
<li><p><code class="sourceCode cpp">completion_behaviour<span class="op">::</span>synchronous</code>:
The connected receiverโs completion-signal happens-before <code class="sourceCode cpp">execution<span class="op">::</span>start<span class="op">()</span></code>
returns.</p></li>
<li><p><code class="sourceCode cpp">completion_behaviour<span class="op">::</span>asynchronous</code>:
The connected receiverโs completion-signal will not occur on the calling
thread before <code class="sourceCode cpp">execution<span class="op">::</span>start<span class="op">()</span></code>
returns.</p></li>
<li><p><code class="sourceCode cpp">completion_behaviour<span class="op">::</span>unknown</code>:
The completion behaviour is unknown.</p></li>
</ul>
<p>If <code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
is an invalid expression no guarantee will be made.</p>
<h1 data-number="4" id="implementation-experience"><span class="header-section-number">4</span> Implementation Experience<a href="#implementation-experience" class="self-link"></a></h1>
<p>libunifex uses a <code class="sourceCode cpp">blocking<span class="op">(</span><span class="kw">const</span> Sender<span class="op">&amp;)</span> <span class="op">-&gt;</span> blocking_kind</code>
query to provide this information for optimizations, which is very
similar to <code class="sourceCode cpp">get_completion_behaviour</code>.
Itโs valid values are</p>
<ul>
<li><code class="sourceCode cpp">maybe</code>: the completion behaviour
is not known</li>
<li><code class="sourceCode cpp">never</code>: the receiver will never
be called on the current thread before
<code class="sourceCode cpp">start<span class="op">()</span></code>
returns.</li>
<li><code class="sourceCode cpp">always</code>: the receiver is
guaranteed to be called on some thread strongly-happens-before
<code class="sourceCode cpp">start<span class="op">()</span></code>
returns.</li>
<li><code class="sourceCode cpp">always_inline</code>: the receiver is
guaranteed to be called inline on the current thread before
<code class="sourceCode cpp">start<span class="op">()</span></code>
returns.</li>
</ul>
<p>The main difference of this proposal to the implementation at
libunifex is, that the query in this proposal acts additionally on the
environment instead of only a sender. Note, that libunifex does not have
receiver environments and the completion behaviour is considered to be a
property of the operation.</p>
<h1 data-number="5" id="design-alternatives"><span class="header-section-number">5</span> Design Alternatives<a href="#design-alternatives" class="self-link"></a></h1>
<p>It was considered to make the query directly dependent on the
operation state instead of a sender and environment pair. While it would
technically work to query the operation states directly, it would also
require to instantiate those operation state types.</p>
<p>Another alternative is to consider a boolean predicate, such as <code class="sourceCode cpp">completes_synchronously<span class="op">(</span>s, env<span class="op">)</span></code>,
instead. Note, that
<code class="sourceCode cpp">inline_completion</code> implies
<code class="sourceCode cpp">synchronous</code> completion. In practise,
standardized senders that are synchronous will complete inline but it is
the synchronous completion property that enables the optimizations. The
current proposal can distinguish between both completion types, inline
and synchronous, and therefore it was chosen over the boolean predicate
formulation.</p>
<h1 data-number="6" id="implications-on-sender-factories-and-adaptors"><span class="header-section-number">6</span> Implications on Sender Factories
and Adaptors<a href="#implications-on-sender-factories-and-adaptors" class="self-link"></a></h1>
<p>The following section describes how to compute the values for the
query for each sender algorithm in <code class="sourceCode cpp">std<span class="op">::</span>execution</code> and
its default implementations. Domain specializations are allowed to
change those values.</p>
<p>For sake of computations we assume the following total order of
values:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>unknown &lt; asynchronous &lt; synchronous &lt; always_inline</span></code></pre></div>
<h2 data-number="6.1" id="sender-factories"><span class="header-section-number">6.1</span> Sender Factories<a href="#sender-factories" class="self-link"></a></h2>
<p>In general, each sender factory needs to provide the information from
its respective implementation.</p>
<h3 data-number="6.1.1" id="schedulerun_loopscheduler"><span class="header-section-number">6.1.1</span>
schedule(run_loop::scheduler)<a href="#schedulerun_loopscheduler" class="self-link"></a></h3>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour</code>:
<code class="sourceCode cpp">asynchronous</code></li>
</ul>
<h3 data-number="6.1.2" id="just-just_error-just_stopped"><span class="header-section-number">6.1.2</span> just(), just_error(),
just_stopped()<a href="#just-just_error-just_stopped" class="self-link"></a></h3>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour</code>:
<code class="sourceCode cpp">inline_completion</code></li>
</ul>
<h3 data-number="6.1.3" id="read_env"><span class="header-section-number">6.1.3</span> read_env()<a href="#read_env" class="self-link"></a></h3>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour</code>:
<code class="sourceCode cpp">inline_completion</code></li>
</ul>
<h2 data-number="6.2" id="sender-adaptors"><span class="header-section-number">6.2</span> Sender Adaptors<a href="#sender-adaptors" class="self-link"></a></h2>
<h3 data-number="6.2.1" id="finallysender1-sender2-continues_onsender-scheduler-starts_onscheduler-sender"><span class="header-section-number">6.2.1</span> <code class="sourceCode cpp">finally<span class="op">(</span>sender1, sender2<span class="op">)</span>, continues_on<span class="op">(</span>sender, scheduler<span class="op">)</span>, starts_on<span class="op">(</span>scheduler, sender<span class="op">)</span></code><a href="#finallysender1-sender2-continues_onsender-scheduler-starts_onscheduler-sender" class="self-link"></a></h3>
<p>Let <code class="sourceCode cpp">s</code> denote the expression <code class="sourceCode cpp">finally<span class="op">(</span>sender1, sender2<span class="op">)</span></code>.</p>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
returns <code class="sourceCode cpp">min<span class="op">(</span>get_completion_behaviour<span class="op">(</span>sender1, env<span class="op">)</span>, get_completion_behaviour<span class="op">(</span>sender2, env<span class="op">))</span></code></li>
</ul>
<h3 data-number="6.2.2" id="thensender-fn-upon_errorsender-fn-upon_stoppedsender-fn"><span class="header-section-number">6.2.2</span> <code class="sourceCode cpp">then<span class="op">(</span>sender, fn<span class="op">)</span></code>,
<code class="sourceCode cpp">upon_error<span class="op">(</span>sender, fn<span class="op">)</span></code>,
<code class="sourceCode cpp">upon_stopped<span class="op">(</span>sender, fn<span class="op">)</span></code><a href="#thensender-fn-upon_errorsender-fn-upon_stoppedsender-fn" class="self-link"></a></h3>
<p>Let <code class="sourceCode cpp">s</code> denote the expression <code class="sourceCode cpp">then<span class="op">(</span>sender, fn<span class="op">)</span></code>.</p>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
returns <code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>sender, env<span class="op">)</span></code></li>
</ul>
<h3 data-number="6.2.3" id="let_valuesender-fn-let_errorsender-fn-let_stoppedsender-fn"><span class="header-section-number">6.2.3</span> <code class="sourceCode cpp">let_value<span class="op">(</span>sender, fn<span class="op">)</span></code>,
<code class="sourceCode cpp">let_error<span class="op">(</span>sender, fn<span class="op">)</span></code>,
<code class="sourceCode cpp">let_stopped<span class="op">(</span>sender, fn<span class="op">)</span></code><a href="#let_valuesender-fn-let_errorsender-fn-let_stoppedsender-fn" class="self-link"></a></h3>
<p>Let <code class="sourceCode cpp">s</code> denote the expression <code class="sourceCode cpp">let_value<span class="op">(</span>sender, fn<span class="op">)</span></code>.
Let <code class="sourceCode cpp">rs<span class="op">...</span></code>
denote the set of all possible result-senders returned from
<code class="sourceCode cpp">fn</code>.</p>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
returns <code class="sourceCode cpp">min<span class="op">(</span>get_completion_behaviour<span class="op">(</span>sender, env<span class="op">)</span>, get_completion_behaviour<span class="op">(</span>rs, env<span class="op">)...)</span></code></li>
</ul>
<h3 data-number="6.2.4" id="into_variantsender-stopped_as_optionalsender"><span class="header-section-number">6.2.4</span> <code class="sourceCode cpp">into_variant<span class="op">(</span>sender<span class="op">)</span></code>,
<code class="sourceCode cpp">stopped_as_optional<span class="op">(</span>sender<span class="op">)</span></code><a href="#into_variantsender-stopped_as_optionalsender" class="self-link"></a></h3>
<p>Let <code class="sourceCode cpp">s</code> denote the expression <code class="sourceCode cpp">into_variant<span class="op">(</span>sender, fn<span class="op">)</span></code>.</p>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
returns <code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>sender, env<span class="op">)</span></code></li>
</ul>
<h3 data-number="6.2.5" id="bulksender-shape-fn"><span class="header-section-number">6.2.5</span> <code class="sourceCode cpp">bulk<span class="op">(</span>sender, shape, fn<span class="op">)</span></code><a href="#bulksender-shape-fn" class="self-link"></a></h3>
<p>Let <code class="sourceCode cpp">s</code> denote the expression <code class="sourceCode cpp">bulk<span class="op">(</span>sender, shape, fn<span class="op">)</span></code>.</p>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>:
<code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>sender, env<span class="op">)</span></code></li>
</ul>
<h3 data-number="6.2.6" id="when_allsenders..."><span class="header-section-number">6.2.6</span> <code class="sourceCode cpp">when_all<span class="op">(</span>senders<span class="op">...)</span></code><a href="#when_allsenders..." class="self-link"></a></h3>
<p>Let <code class="sourceCode cpp">s</code> denote the expression <code class="sourceCode cpp">when_all<span class="op">(</span>senders<span class="op">...)</span></code>.</p>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>
returns <code class="sourceCode cpp">min<span class="op">(</span>get_completion_behaviour<span class="op">(</span>senders, env<span class="op">)...)</span></code></li>
</ul>
<h3 data-number="6.2.7" id="splitsender"><span class="header-section-number">6.2.7</span> <code class="sourceCode cpp">split<span class="op">(</span>sender<span class="op">)</span></code><a href="#splitsender" class="self-link"></a></h3>
<p>Let <code class="sourceCode cpp">s</code> denote the expression <code class="sourceCode cpp">split<span class="op">(</span>sender<span class="op">)</span></code>.</p>
<ul>
<li><code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>s, env<span class="op">)</span></code>:
<ul>
<li>Returns a dynamic value. The operation of <code class="sourceCode cpp">split<span class="op">(</span>sender<span class="op">)</span></code>
completes inline if the input operation has completed before starting a
new copy of split. Otherwise the query returns <code class="sourceCode cpp">get_completion_behaviour<span class="op">(</span>sender, env<span class="op">)</span></code>.</li>
</ul></li>
</ul>
<h1 data-number="7" id="bibliography"><span class="header-section-number">7</span> References<a href="#bibliography" class="self-link"></a></h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="1" role="doc-bibliography">
<div id="ref-P2257R0" class="csl-entry" role="doc-biblioentry">
[P2257R0] Dalton M. Woodard. 2020-11-22. Blocking is an insufficient
description for senders and receivers. <a href="https://wg21.link/p2257r0"><div class="csl-block">https://wg21.link/p2257r0</div></a>
</div>
</div>
</div>
</div>
</body>
</html>
